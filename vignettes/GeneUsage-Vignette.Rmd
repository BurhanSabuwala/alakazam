---
title: 'Alakazam: Gene usage analysis'
author: "Susanna Marquez"
date: '`r Sys.Date()`'
output:
  pdf_document:
    dev: pdf
    fig_height: 4
    fig_width: 7.5
    highlight: pygments
    toc: yes
  md_document:
    fig_height: 4
    fig_width: 7.5
    preserve_yaml: no
    toc: yes
  html_document:
    fig_height: 4
    fig_width: 7.5
    highlight: pygments
    theme: readable
    toc: yes
geometry: margin=1in
fontsize: 11pt
vignette: >
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteIndexEntry{Gene usage analysis}
  %\usepackage[utf8]{inputenc}
---

The `alakazam` package includes a set of function to analyze the usage of V(D)J alleles, genes and families.


## Example data

A small example Change-O database, `ExampleDb`, is included in the `alakazam` package. 

```{r, eval=TRUE, warning=FALSE, message=FALSE}
# Load required packages
library(alakazam)
library(dplyr)
library(scales)

# Subset example data
data(ExampleDb)
db <- ExampleDb[ExampleDb$SAMPLE == "+7d", ]
```

## Tabulate V(D)J allele, gene or family usage

The relative abundance of V(D)J alleles, genes or families within groups can be obtained with the function `countGenes`. To analyze differences in the V gene usage across the different samples in the `ExampleDb`,
we set `groups="SAMPLE"`. The V gene calls are in the column named `V_CALL`, and we will use gene names.

```{r, eval=TRUE, warning=FALSE, fig.width=7.5, fig.height=6}
genes <- countGenes(ExampleDb, gene="V_CALL", groups=c("SAMPLE"), 
                    clone="CLONE", mode="gene")
head(genes)
```

```{r gene_usage_plot}
ggplot(genes, aes(x=GENE, y=SEQ_FREQ)) +
    theme_bw() +
    theme(axis.text.x=element_text(angle=45, hjust=1, vjust=1)) +
    theme(legend.position="bottom") +
    ylab("Percent of repertoire") +
    xlab("") +
    ggtitle("V Gene usage") +
    scale_y_continuous(labels=percent, breaks=seq(0, 1, 0.05)) +
    geom_point(aes(color=SAMPLE, group=SAMPLE), 
               position=position_dodge(0.9), size=1.5, pch=18, alpha=0.7) +    
    geom_vline(xintercept=seq(1.5, length(unique(genes$GENE)) - 0.5, 1), 
               color="grey30", linetype=3, size=0.25)
```

We can add the ISOTYPE field to the grouping variables to explore differences in gene usage across isotypes.

```{r, eval=TRUE, warning=FALSE, fig.width=7.5, fig.height=6}
genes <- countGenes(ExampleDb, gene="V_CALL", groups=c("SAMPLE", "ISOTYPE"), 
                    clone="CLONE", mode="gene")
head(genes)
```


```{r isotype_usage_plot, fig.width=10, fig.height=15}
ggplot(genes, aes(x=GENE, y=SEQ_FREQ)) +
    theme_bw() +
    alakazam:::getBaseTheme() +
    theme(axis.text.x=element_text(angle=45, hjust=1, vjust=1)) +
    theme(legend.position="bottom") +
    ylab("Percent of repertoire") +
    xlab("") +
    ggtitle("V Gene usage, by isotype") +
    scale_y_continuous(labels=percent, breaks=seq(0, 1, 0.05)) +
    geom_point(aes(color=SAMPLE, group=SAMPLE), 
               position=position_dodge(0.9), size=1.5, pch=18, alpha=0.7) +    
    geom_vline(xintercept=seq(1.5, length(unique(genes$GENE)) - 0.5, 1), 
               color="grey30", linetype=3, size=0.25) + 
    facet_wrap(~ISOTYPE, ncol=1, scales="free_y")
```

